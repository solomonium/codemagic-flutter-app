workflows:
  ios-workflow:
    name: iOS Workflow
    instance_type: mac_mini_m2
    max_build_duration: 120
    environment:
      vars:
        FIREBASE_APP_ID: "1:947149653644:ios:f65e080c90dfff03f99da9"
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install Flutter packages
        script: flutter pub get

      - name: Install CocoaPods
        script: |
          cd ios
          pod install
          cd ..

      - name: Build IPA
        script: |
          flutter build ipa --release --no-codesign
          echo "âœ… IPA generated at build/ios/ipa/Runner.ipa"

      - name: Decode Service Account
        script: |
          GOOGLE_APPLICATION_CREDENTIALS_BASE64="ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiY29kZW1hZ2ljLWZsdXR0ZXItYXBwLTIyZWQ3IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiYmViZjRjZTcyMWQyY2I2M2RkN2Y5MzI0ZTk0YmI4M2YyZWUzNTZjYiIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDcTZpUGRZaGQ5M2hPN1xuYURydHo2bmxublJsYldDYktyNlZrV0xjam1HbzBBK0VmSzN2RjFOeCtDd1BmOFBIZEU5VzY1Nllhd1BIcnl2NFxuT3VxNEttdkxwbENxSFE5TE81dEY4MU13NkJEZW9lbXdlMVV3TDBzMWtXMDNiUHFlM3pHb3J3ZlcwQm45dXJoY1xuVzUzYm1pUk85OVZsR29rYnQxT1JQWE05SHJPZ254YlBadmdjQ1YyYk8yMWJ4TnhLTWFTL0QxbWNhcjJoZSszU1xueGRPK0V6N2xBbkp1NjZHNUpnS1BLZDB2UkRmTHhEcHFmUURaaDJrQTNtenBlOHYweDZUTDlPSzJRaWhOaWhFZ1xuYzlIUEZXUjVLSmR1ZXZJUlB4U2ZsdGJhKzFRRXkrVnplcUwxd1VHbnV5S1hRdFVqR0c3NGxrZ2s2ZHpmZDFkTlxuOFlPaG43RlhBZ01CQUFFQ2dnRUFIaTFzT3JVTXA4MHoxN1d1SGZvNktkQmlCZHlibjVvYS80YWxtWUxNVElXOFxuRDYwQit3SzMyWm96a1dNQ091L1c2R1orNExPWWZjUDR0QUlYR29CbSt4UzVEbWhHSUliOFFnd1dCcjhhNTJ4WVxuT2pCMG1LYnBGU0xCMFhUOUJWc3NSZmZ0bnVpc2hpZlhVSHRlc24wVFp4d01RaWMreVRXRDNGT295c1JtZS9nQlxuR0NnazRDZHFja3MxWlBwODJOYkg2ZEcwTjBMdzhKL2dqaDRGVUdYdnQrQlg4cUZFSCttaFNjRFA1NXIvNEVIblxudW5EbUhlTWNUWGFoZXVHeFZaSUVtMk9rVDF3ZkZPSCt3VmhJVEhmaU1nc21oV0dHVit0RlZlV25ua1RpV21MSFxuekcrV1N4emh2ZFlDS1AyZ0FGVVJFQmRiUWpVclFyVGpoQjh6TCszUTJRS0JnUURiWXVIZnFzOTVOSzlRSnYzSVxubzVjQ29uSTE2WDBQcTUvVFp3T2N3S1JIcDZFb2d3ZHVKUnBCMHFDc2dFL2t1UURmczJJWHJmT29oMVQ4c2k3SlxuN0p6SWE3SmNXeDZlTncwdlRzaUJNWnZzMGtPVVBiTkNNRUNUNUZlODQxSFJzbHJwQ3d3VWNEYnBnWDhSM0gwYVxuWG5pbjVkWHU0d1RlVm1xemJld3pTQ1hwcndLQmdRREhjRmVLOTljUXFpbndERjg3MTNYbktBeUthRDlvNFAyUFxualkrNFI4dWpSbHhaSEJVVHkxQzljVk5RL3hDbllTeEpHOFpFQmowd3JyNnpsTTBidGhVRmJZb1c0R1p4RGlKelxuTWVUTWxyTmg4MWhaMk00OTIwWFNvNm5LY21RbVZwNmsrTWNxcHcycEdBRDVXemNuNzhDRndDcXk0M3dlajhXRlxuRVhDQmJXQWsyUUtCZ1FESEs2eDRqUEF5ejd2aGZxU2tSTEJTT2Z5S0tXSGFtaXRObDVaVjl5YXR6dWVtaWQ1elxuQnNnaHZnRVUycUN0dTYrcFo0ZkVpNjVMOENFZUVQNGRYK3l1bitlYnBUWFUyWkhrd3hlUkF1TFdTOFlDalVseVxuNjYrVkZKYjY2ejFhclJ1UHV2SEtsRjJsL0dUS2FHeERSa1V2Mko4eWMzUDJEbXBzWDMweXlXdHlEUUtCZ0EvNVxuTm5uQjZlN0N3a01ncW92L2NNa0gweUZPd2kxalA4dThtZE0zcE42NTV2R1lKelFEcDc3VWtjaTk5UmFDMk9vdVxuR0U0Z2Rjd3RZc2E5VjBRdDdEY1lFK1JMS3NsSlNZY1NhdkhiN0JnZlJtZER6eGp6TS85djdreHhwd1hQRUR2RVxuVlNkY1krSzBNbmZHVDMrYVcwQWJLUkJVMmY4VW9zeEtua2t2ZW5EWkFvR0FLWm5kMW56eDBYelBWdFRhc1RMb1xudTNRSGFYeGNURUVYTmxnL1M0NUJLS2hBWWI4TVVaN0NualQ1NHVHV2Vzd0xiVnhNV3ZTVm9UUmtsRm5pWm02OVxudVBFbUpWYW5GaXhjRWVQVGZpR0Rncm43WHdRWS9TSzlmVVpmNzc4Vk1sMVN0a2ZpNWdCdUMyRE5yamdtMDZ3OVxubFRqQVZ4VTAzZUVqL2NnZUgrMFBzcGc9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiZmlyZWJhc2UtYWRtaW5zZGstZmJzdmNAY29kZW1hZ2ljLWZsdXR0ZXItYXBwLTIyZWQ3LmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjEwNDU0OTkxMzI3MTgyNzU0MjQ4MyIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvZmlyZWJhc2UtYWRtaW5zZGstZmJzdmMlNDBjb2RlbWFnaWMtZmx1dHRlci1hcHAtMjJlZDcuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K"

          echo "$GOOGLE_APPLICATION_CREDENTIALS_BASE64" | base64 -d > /tmp/service-account.json

          if ! jq . /tmp/service-account.json > /dev/null 2>&1; then
            echo "Error: Decoded service account JSON is invalid or empty"
            exit 1
          else
            echo "Service account JSON is valid"
          fi

      - name: Distribute to Firebase
        script: |
          export GOOGLE_APPLICATION_CREDENTIALS="/tmp/service-account.json"

          firebase appdistribution:distribute build/ios/ipa/Runner.ipa \
            --app "$FIREBASE_APP_ID" \
            --groups "testers" \
            --release-notes "Build $CM_BUILD_NUMBER - Unsigned IPA"

    artifacts:
      - build/ios/ipa/Runner.ipa

    publishing:
      email:
        recipients:
          - laleye.solomon@yahoo.com
          - laleyesolomon2@gmail.com
        notify:
          success: true
          failure: true
